{% extends 'base_back.html.twig' %}

{% block title %}Events{% endblock %}

{% block navigate %}

          <div class="menu-inner-shadow"></div>

          <ul class="menu-inner py-1">
            <!-- Dashboard -->
            <li class="menu-item ">
              <a href="{{ path('app_homeback') }}" class="menu-link">
                <i class="menu-icon tf-icons bx bx-home-circle"></i>
                <div data-i18n="Analytics">Dashboard</div>
              </a>
            </li>

            
            <!-- Events -->
            <li class="menu-header small text-uppercase"><span class="menu-header-text">Events</span></li>
            <!-- List Events -->
            <li class="menu-item active">
              <a href="{{ path('app_Affiche') }}" class="menu-link">
                <i class="menu-icon tf-icons bx bx-collection"></i>
                <div data-i18n="Basic">List Events</div>
              </a>
            </li>
            <!-- Add Events -->
            <li class="menu-item ">
                <a href="{{ path('app_Add') }}" class="menu-link">
                    <i class="menu-icon tf-icons bx bx-plus-circle"></i>
                  <div data-i18n="Basic">Add Events</div>
                </a>
            </li>
        
          </ul>
        </aside>

        <!-- / Menu -->
{% endblock %}

{% block body %}
    <div class="container mt-4">
        <div class="row mb-3">
            <div class="col-12">
                <a href="{{ path('app_editEvent', {'id': event.id}) }}" class="btn btn-primary">Edit</a>
                <a href="{{ path('app_deleteEvent', {'id': event.id}) }}" class="btn btn-danger">Delete</a>
                <a href="{{ path('app_Affiche') }}" class="btn btn-secondary">Back to list</a>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                
                {% if event.image %}
                    <img src="{{ asset('uploads/images/' ~ event.image) }}" alt="{{ event.name }}" class="img-fluid">
                {% endif %}

            </div>

            <div class="col-md-8">
                <h1><strong>Name:</strong> {{ event.name }}</h1>
                <p class="lead"><strong>Type:</strong> {{ event.type }}</p>
                <p><strong>Nombre Places:</strong> {{ event.nbPlaces }}</p>
                <p><strong>Description:</strong> {{ event.description }}</p>
            <!--    
                <p><strong>Address:</strong> {{ event.address }}</p>
                <p><strong>Date Debut:</strong> {{ event.datedebut|date('Y-m-d') }}</p>
                <p><strong>Date Fin:</strong> {{ event.datefin|date('Y-m-d') }}</p>
            -->
            </div>
        </div>

<div class="row">       
<!--*******************************************************************************************************************************************-->
<div class="col-md-4">
    <div id="calendar" style="height: 220px; width: 370px;"></div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@3.10.2/dist/fullcalendar.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@3.10.2/dist/fullcalendar.min.js"></script>

    <script>
        // Extracting start and end dates from your event
        var startDate = '{{ event.datedebut|date("Y-m-d") }}';
        var endDate = moment('{{ event.datefin|date("Y-m-d") }}').add(1, 'days').format('YYYY-MM-DD');

        $('#calendar').fullCalendar({
            defaultView: 'month',
            events: [
                {
                    title: 'Your Event',
                    start: startDate,
                    end: endDate 
                }
            ],
            // Set the initial date to the event's start date
            viewRender: function(view, element) {
                $('#calendar').fullCalendar('gotoDate', moment(startDate));
            },
            dayClick: function(date, jsEvent, view) {
                if (jsEvent.target.classList.contains('fc-prev-button')) {
                    $('#calendar').fullCalendar('prev');
                } else if (jsEvent.target.classList.contains('fc-next-button')) {
                    $('#calendar').fullCalendar('next');
                }
            },
            header: {
                //left: 'prev,next',
                left: '',
                center: 'title',
                right: '',
                //right: 'today,
            },
        });

    </script>
</div>



<!--******************************************************************************************************************************************-->
<div class="col-md-8">

        <!--<div id="map" style="height: 250px; width: 600px;"></div>-->
        <div id="map" style="height: 300px; width: 770px;"></div>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <script src="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder/dist/Control.Geocoder.css" />

        <script>
            // Function to extract coordinates from Google Maps URL
            function extractCoordinatesFromGoogleMapsUrl(googleMapsUrl) {
                // Extracting coordinates from the URL
                var matches = googleMapsUrl.match(/@(-?\d+\.\d+),(-?\d+\.\d+),(\d+)z/);

                if (matches && matches.length === 4) {
                    var latitude = parseFloat(matches[1]);
                    var longitude = parseFloat(matches[2]);
                    return [latitude, longitude];
                } else {
                    console.error('Error parsing Google Maps URL');
                    return null;
                }
            }

            // Extracting coordinates from the Google Maps URL
            var eventAddress = '{{ event.address }}'; // Assuming '{{ event.address }}' is a placeholder for the actual address
            var coordinates = extractCoordinatesFromGoogleMapsUrl(eventAddress);

            if (coordinates) {
                // Log coordinates to the console for debugging
                console.log('Coordinates:', coordinates);

                // Set up the Leaflet map
                var map = L.map('map').setView(coordinates, 13);

                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Add a marker to the map
                L.marker(coordinates).addTo(map)
                    .bindPopup(' ' + '{{ event.name }}')
                    .openPopup();
            } else {
                console.error('Error extracting coordinates from Google Maps URL');
            }
        </script>
</div>

<!-- *****************************************************************************************************************-->
</div>

        <hr>
        <div class="row mt-4">
            <div class="col-md-6">
                <h2>Participants</h2>
                <p><strong>Places Reserved:</strong> {{ event.nbPlacesR }} / {{ event.nbPlaces }}</p>
                <ul class="list-group">
                    {% for participant in event.participants %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                             {{ participant.user.name }}
                        </div>
                        <div>
                            <a href="{{ path('app_deleteparticipantA', {'ref': participant.id, 'idevent': event.id}) }}"
                            class="btn btn-danger btn-sm">Delete</a>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="col-md-6">
                <h2>Comments</h2>
                {% if event.comments|length > 0 %}
                    <ul class="list-group">
                        {% for comment in event.comments %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ comment.user.name }}:</strong> {{ comment.commentaire }}
                                </div>
                                <div>
                                    <a href="{{ path('app_deletecommentA', {'ref': comment.id, 'idevent': event.id}) }}"
                                        class="btn btn-danger btn-sm">Delete</a>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No comments yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}